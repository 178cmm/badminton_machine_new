# 🏸 羽毛球發球機控制系統

## 📋 概述

這是一個功能完整的羽毛球發球機控制系統，採用模組化設計，支援多種控制方式和訓練模式。系統整合了圖形界面、語音控制、藍牙通訊和智能訓練功能，提供專業級的羽毛球訓練體驗。

## 🚀 主要功能

### 🎯 手動控制模式
- **單發模式**：點擊位置按鈕直接發送一顆球
- **連發模式**：設定球數和間隔，連續發送多顆球到指定位置
- **25宮格發球區域**：前場、中場、後場精準控制
- **雙發球機支援**：同時控制兩台發球機，支援交替/同時/序列發球

### 🎙️ 智能語音控制系統
- **Whisper API 語音識別**：高準確度語音轉文字
- **智能規則匹配**：自動識別訓練指令
- **TTS 語音回覆**：即時語音反饋，支援多種語音選擇
- **VAD 自動偵測**：智能語音活動偵測
- **預載入系統**：常用查詢預先準備，提升響應速度
- **模式管理**：控制模式/思考模式智能切換

### 🏃‍♂️ 多種訓練模式
- **基礎訓練**：單一球路反覆練習，支援教學影片播放
- **進階訓練**：多球路組合訓練
- **模擬對打**：智能對打模擬（12個等級，支援雙發球機）
- **熱身模式**：系統化熱身訓練
- **動態課程**：基於自然語言理解的智能課程匹配

### 📱 完整用戶界面
- **連接管理**：藍牙設備掃描和連接（單/雙發球機）
- **實時監控**：訓練進度和狀態顯示
- **日誌記錄**：詳細的操作記錄和審計追蹤
- **文字指令**：支援文字輸入控制
- **模擬面板**：開發和測試用的模擬控制面板

## 🏗️ 系統架構

```
羽毛球發球機控制系統/
├── 🎯 用戶界面層 (GUI Layer)
│   ├── main.py                    # 主程式入口
│   ├── gui/                       # 圖形界面模組
│   │   ├── main_gui.py           # 主界面控制器
│   │   ├── ui_connection.py      # 藍牙連接管理界面
│   │   ├── ui_control.py         # 手動控制界面（單/雙發球機）
│   │   ├── ui_voice.py           # 語音控制界面
│   │   ├── ui_training.py        # 基礎訓練界面
│   │   ├── ui_advanced_training.py # 進階訓練界面
│   │   ├── ui_simulation.py      # 模擬對打界面
│   │   ├── ui_warmup.py          # 熱身模式界面
│   │   ├── ui_text_input.py      # 文字指令輸入界面
│   │   ├── ui_log.py             # 日誌查看界面
│   │   ├── ui_simulate_panel.py  # 模擬控制面板
│   │   ├── video_player.py       # 影片播放器
│   │   └── response_templates.py # 語音回應模板
│
├── 🧠 核心業務層 (Core Layer)
│   ├── core/                      # 核心功能模組
│   │   ├── router.py             # 命令路由器
│   │   ├── commands.py           # 命令定義
│   │   ├── executors/            # 執行器模組
│   │   │   ├── basic_training_executor.py    # 基礎訓練執行
│   │   │   ├── advanced_training_executor.py # 進階訓練執行
│   │   │   ├── simulation_executor.py        # 模擬對打執行
│   │   │   ├── warmup_executor.py            # 熱身執行
│   │   │   ├── dual_machine_executor.py      # 雙發球機執行
│   │   │   └── text_command_executor.py      # 文字命令執行
│   │   ├── parsers/              # 解析器模組
│   │   │   ├── unified_parser.py             # 統一解析器
│   │   │   ├── basic_training_parser.py      # 基礎訓練解析
│   │   │   ├── advanced_training_parser.py   # 進階訓練解析
│   │   │   ├── simulation_parser.py          # 模擬對打解析
│   │   │   └── warmup_parser.py              # 熱身解析
│   │   ├── managers/             # 管理器模組
│   │   │   ├── bluetooth_manager.py          # 藍牙連接管理
│   │   │   ├── dual_bluetooth_manager.py     # 雙發球機藍牙管理
│   │   │   └── dual_bluetooth_thread.py      # 雙發球機線程管理
│   │   ├── services/             # 服務層
│   │   │   ├── device_service.py             # 設備服務
│   │   │   ├── system_service.py             # 系統服務
│   │   │   └── training_service.py           # 訓練服務
│   │   ├── nlu/                  # 自然語言理解
│   │   │   ├── matcher.py                    # 規則匹配器
│   │   │   └── normalizer.py                 # 文本正規化
│   │   ├── registry/             # 註冊中心
│   │   │   └── program_registry.py           # 訓練課程註冊
│   │   ├── utils/                # 工具模組
│   │   │   ├── shot_selector.py              # 擊球選擇器
│   │   │   └── video_config.py               # 視頻配置
│   │   └── audit/                # 審計系統
│   │       └── audit_reader.py               # 審計日誌讀取器
│
├── 🔗 通訊層 (Communication Layer)
│   ├── bluetooth.py              # 藍牙通訊核心
│   ├── voice_control_tts.py      # 新版語音控制（Whisper + TTS）
│   ├── voice_control.py          # 舊版語音控制（Vosk）
│   └── voice_control_cli.py      # 語音控制命令列介面
│
├── 📁 配置與數據層 (Config & Data Layer)
│   ├── area.json                 # 25個發球區域的參數配置
│   ├── training_programs.json    # 訓練課程定義
│   ├── config/                   # 配置文件
│   │   ├── aliases.yaml         # 命令別名配置
│   │   └── suffixes.yaml        # 後綴配置
│   ├── rules/                    # 規則文件
│   │   ├── badminton_rules.yaml # 語音控制規則
│   │   └── badminton_rules_en.yaml # 英文語音控制規則
│   ├── cache/                    # 快取文件
│   │   └── reply_cache.json     # 語音回應快取
│   └── logs/                     # 系統日誌
│       └── commands.jsonl        # 命令執行日誌
│
└── 🛠️ 工具與測試層 (Tools & Testing Layer)
    ├── tools/                    # 工具腳本
    │   └── sim_e2e.py           # 端到端模擬測試
    ├── scripts/                  # 腳本工具
    │   └── no_deprecated_imports.py # 檢查deprecated引用
    └── experimental/             # 實驗性功能
        └── dual/                # 雙發球機實驗功能
```

## 🚀 安裝與使用

### 📋 環境要求
- **Python 3.8+**
- **PyQt5** - 圖形界面框架
- **OpenAI API Key** - 語音控制功能（Whisper + TTS）
- **藍牙支援** - 發球機連接
- **音訊設備** - 語音輸入輸出

### 📦 安裝步驟

1. **克隆專案**
```bash
git clone <repository-url>
cd coding_1
```

2. **安裝依賴套件**
```bash
pip install -r requirements.txt
```

3. **設定 OpenAI API Key**
```bash
export OPENAI_API_KEY="your-api-key-here"
```

4. **啟動程式**
```bash
python main.py
```

### 🎮 快速開始

#### GUI 模式（推薦）
```bash
python main.py
```
- 啟動圖形界面
- 支援所有功能模組
- 即時狀態顯示

#### 語音控制命令列模式
```bash
# 基本使用
python voice_control_cli.py

# 持續對話模式
python voice_control_cli.py --continuous

# 低延遲模式
python voice_control_cli.py --low-latency

# 思考模式
python voice_control_cli.py --default-mode think
```

#### 模擬模式（無實機測試）

若要在無實機情境下端到端演練：

1. **設定模擬模式**
```bash
export SIMULATE=true
```

2. **執行端到端腳本**
```bash
python tools/sim_e2e.py
```

3. **查看審計日誌**
```bash
tail -f logs/commands.jsonl
```

4. **運行測試套件**
```bash
pytest -k sim  # 模擬相關測試
```

## 📖 使用指南

### 🎯 手動控制
1. **單發球機模式**
   - 切換到「手動控制」→「單發球機」標籤頁
   - 選擇發球模式（單發/連發）
   - 點擊目標位置按鈕
   - 在連發模式下設定球數和間隔
   - 點擊「開始連發」執行

2. **雙發球機模式**
   - 切換到「手動控制」→「雙發球機」標籤頁
   - 選擇協調模式（交替/同時/序列）
   - 設定發球間隔和次數
   - 選擇左右發球機目標位置
   - 點擊「開始協調發球」執行

### 🎙️ 語音控制
1. **基本設定**
   - 切換到「語音控制」標籤頁
   - 設定 OpenAI API Key
   - 選擇音訊裝置和語音類型
   - 點擊「啟動語音控制」

2. **常用語音指令**
   - **連接控制**：「掃描發球機」、「連接」、「斷開」
   - **訓練控制**：「開始訓練」、「停止訓練」、「前場練習」
   - **發球控制**：「快速發球」、「慢速發球」、「左邊發球」
   - **模式切換**：「啟動思考模式」、「啟動控制模式」

### 🏃‍♂️ 訓練模式

#### 基礎訓練
1. 切換到「基礎訓練」標籤頁
2. 選擇訓練項目（支援教學影片播放）
3. 設定訓練速度（慢/正常/快/極限快）
4. 選擇發球數量（10顆/20顆/30顆）
5. 點擊「開始發球」開始訓練

#### 進階訓練
1. 切換到「進階訓練」標籤頁
2. 選擇訓練課程
3. 設定訓練參數
4. 點擊「開始訓練」

#### 模擬對打
1. 切換到「模擬對打」標籤頁
2. 選擇對打等級（1-12級）
3. 可選：勾選「使用雙發球機模式」
4. 點擊「開始模擬對打」

#### 熱身模式
1. 切換到「熱身模式」標籤頁
2. 選擇熱身項目
3. 設定熱身參數
4. 點擊「開始熱身」

### 🔗 連接管理

#### 單發球機連接
1. 切換到「連接設定」→「單發球機」標籤頁
2. 點擊「🔍 掃描發球機」
3. 選擇目標設備
4. 點擊「🔗 連接發球機」

#### 雙發球機連接
1. 切換到「連接設定」→「雙發球機」標籤頁
2. 點擊「🔍 掃描雙發球機」
3. 分別選擇左發球機和右發球機
4. 點擊「🔗 連接雙發球機」

## 🔧 技術特色

### 🧠 智能語音控制
- **Whisper API**：高精度語音識別
- **自然語言理解**：智能指令解析
- **規則匹配系統**：快速指令識別
- **TTS 語音回覆**：即時語音反饋
- **預載入系統**：常用查詢快取
- **模式管理**：控制/思考模式切換

### ⚡ 異步處理架構
- **非阻塞 UI**：流暢的用戶體驗
- **異步藍牙通訊**：穩定的設備連接
- **多線程語音處理**：並行音訊處理
- **實時狀態更新**：即時系統狀態反饋

### 🏗️ 模組化設計
- **清晰架構**：分層設計，職責明確
- **可擴展性**：易於添加新功能
- **獨立模組**：執行器、解析器、管理器分離
- **統一接口**：標準化的模組間通訊

### 🎯 智能訓練系統
- **動態課程匹配**：基於自然語言的課程選擇
- **12級模擬對打**：從初學者到專業級的完整訓練體系
- **雙發球機協調**：智能雙機協調發球
- **影片教學支援**：整合教學影片播放

### 📊 數據管理
- **審計追蹤**：完整的操作記錄
- **配置管理**：靈活的參數調整
- **快取系統**：提升響應速度
- **日誌分析**：詳細的系統監控

## 📁 配置檔案

### 核心配置文件
- **`area.json`**：25個發球區域的參數配置
- **`training_programs.json`**：訓練課程定義和配置
- **`config/aliases.yaml`**：命令別名和同義詞配置
- **`config/suffixes.yaml`**：後綴移除規則配置
- **`rules/badminton_rules.yaml`**：語音控制規則定義

### 數據文件
- **`cache/reply_cache.json`**：語音回應快取
- **`logs/commands.jsonl`**：命令執行審計日誌

## 🔍 故障排除

### 常見問題

1. **藍牙連接失敗**
   - 檢查發球機電源和藍牙狀態
   - 確認設備名稱以 `YX-BE241` 開頭
   - 重新掃描並連接設備

2. **語音識別不準確**
   - 確認網路連接正常
   - 檢查 OpenAI API Key 設定
   - 調整音訊設備和環境噪音

3. **發球機無響應**
   - 檢查藍牙連接狀態
   - 確認發球機電量充足
   - 重新連接發球機

4. **影片無法播放**
   - 檢查影片文件是否存在
   - 確認影片格式支援
   - 安裝 GStreamer 插件

### 日誌查看
- **系統日誌**：`logs/commands.jsonl`
- **GUI 日誌**：在「日誌」標籤頁查看
- **審計追蹤**：完整的操作記錄

## 👨‍💻 開發者資訊

### 代碼結構
- **`gui/`**：圖形界面相關代碼
- **`core/`**：核心業務邏輯和模組
- **`voice_control*.py`**：語音控制實現
- **`bluetooth.py`**：藍牙通訊核心
- **`tools/`**：開發和測試工具

### 擴展開發
系統採用模組化設計，可以輕鬆添加：
- 新的訓練模式
- 新的控制方式
- 新的語音指令
- 新的設備支援

### 開發流程
1. 查看 `CONTRIBUTING.md` 了解開發規範
2. 使用模擬模式進行測試
3. 運行端到端測試腳本
4. 檢查審計日誌

## 📈 開發進度

### ✅ 已完成功能
- **基礎手動控制**：單發/連發模式
- **智能語音控制**：Whisper + TTS 整合
- **多種訓練模式**：基礎/進階/模擬對打/熱身
- **雙發球機支援**：協調發球功能
- **影片教學整合**：教學影片播放
- **模擬測試系統**：無實機測試環境
- **審計追蹤系統**：完整操作記錄

### 🚧 進行中功能
- **雙發球機協調優化**：時序精度提升
- **進階訓練擴展**：更多訓練課程
- **效能優化**：響應速度提升

### 📋 規劃功能
- **數據分析**：訓練數據統計
- **自定義訓練**：用戶自定義課程
- **多語言支援**：英文語音控制
- **雲端同步**：訓練數據同步

## 📄 文檔結構

### 主要文檔
- **`README.md`**：本文件，系統總覽
- **`CONTRIBUTING.md`**：開發者貢獻指南
- **`docs/SYSTEM_ARCHITECTURE.md`**：系統架構詳解
- **`docs/INTEGRATION_COMPLETE_README.md`**：語音控制整合說明

### 功能文檔
- **`docs/DUAL_MACHINE_GUIDE.md`**：雙發球機使用指南
- **`docs/VOICE_GUIDE.md`**：語音控制使用指南
- **`docs/SIMULATION_MODE_README.md`**：模擬對打說明
- **`docs/VIDEO_TRAINING_GUIDE.md`**：影片訓練功能指南

### 技術文檔
- **`docs/control_pipeline.md`**：控制管線與狀態機
- **`docs/dynamic_programs.md`**：動態課程與球路匹配
- **`docs/M5_CLEANUP_SUMMARY.md`**：系統清理總結

## 📜 授權

本專案採用 MIT 授權條款。

## 📞 聯絡資訊

如有問題或建議，請：
1. 查看相關文檔和 FAQ
2. 檢查系統日誌
3. 聯繫開發團隊

---

*最後更新：2024年12月*
