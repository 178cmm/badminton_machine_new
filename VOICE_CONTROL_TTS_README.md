# 🎙️ 語音控制系統整合說明

## 📋 整合完成內容

本次整合將 `badminton_tts_package` 中的先進語音控制功能完整整合到羽球發球機控制系統中。

### 🚀 新功能特色

1. **Whisper API 語音識別**
   - 高準確度語音轉錄
   - 支援繁體中文
   - 無需本地模型檔案
   - 自動語音活動偵測 (VAD)

2. **智能規則匹配系統**
   - YAML 配置的規則檔案
   - 支援包含、正則、模糊匹配
   - 優先級控制
   - 熱重載支援

3. **TTS 語音回覆**
   - OpenAI TTS 語音合成
   - 多種語音選擇 (nova, alloy, echo, fable, onyx, shimmer)
   - 可調語速
   - 自動播放回覆

4. **預載入優化**
   - 智能快取系統
   - 常用回覆預載
   - 減少響應延遲

## 🏗️ 檔案結構

### 新增檔案
- `voice_control_tts.py` - 新的語音控制核心模組
- `rules/badminton_rules.yaml` - 羽球訓練指令規則
- `VOICE_CONTROL_TTS_README.md` - 本說明文檔

### 修改檔案
- `gui/ui_voice.py` - 更新語音控制 UI 介面
- `gui/main_gui.py` - 整合新的語音控制系統
- `requirements.txt` - 新增必要依賴套件
- `voice_control.py` - 加入舊版說明，保持向後相容

## 🎯 支援的語音指令

### 基本控制
- **開始訓練** / **啟動** / **開始發球**
- **停止訓練** / **暫停** / **停止發球**
- **結束訓練** / **完成**

### 速度調整
- **快速發球** / **高速** / **超快**
- **慢速發球** / **低速** / **減慢速度**
- **中速發球** / **標準速度**

### 訓練模式
- **前場練習** / **網前練習**
- **後場練習** / **底線練習**
- **殺球練習** / **扣殺**
- **吊球練習** / **輕吊**

### 角度調整
- **左邊** / **左側** / **向左**
- **右邊** / **右側** / **向右**
- **中間** / **中央** / **正中間**

### 高度調整
- **提高** / **上升** / **調高**
- **降低** / **下降** / **調低**

### 球路練習
- **直線球練習** / **直線**
- **斜線球練習** / **對角球**
- **正手練習** / **正手球**
- **反手練習** / **反手球**

### 其他指令
- **熱身練習** / **準備活動**
- **多球練習** / **連續發球**
- **單球練習** / **間隔發球**
- **謝謝** / **感謝** / **辛苦了**
- **再見** / **拜拜**

## ⚙️ 使用方式

### 1. 環境設定
```bash
# 安裝新的依賴套件
pip install -r requirements.txt

# 設定 OpenAI API Key（必須）
export OPENAI_API_KEY="your-api-key-here"
```

### 2. GUI 操作
1. 啟動主程式：`python main.py`
2. 切換到「語音控制」頁面
3. 在「🔑 OpenAI API 設定」區域輸入您的 API Key
4. 選擇音訊輸入裝置
5. 配置語音設定（TTS 語音、啟用選項等）
6. 點擊「🎙️ 啟動語音控制」
7. 開始使用語音指令控制發球機

### 3. 語音指令範例
- 說「開始訓練」→ 系統回覆並啟動發球機
- 說「快速發球」→ 調整為高速發球模式
- 說「前場練習」→ 切換到網前球訓練
- 說「停止訓練」→ 停止發球並結束訓練

## 🔧 技術架構

### 語音處理流程
1. **音訊捕獲** - 使用 sounddevice 和 webrtcvad
2. **語音識別** - Whisper API 轉錄
3. **規則匹配** - YAML 規則系統匹配指令
4. **動作執行** - 調用發球機控制功能
5. **語音回覆** - TTS 合成並播放回覆

### 核心類別
- `VoiceControlTTS` - 主要語音控制類別
- `RuleMatcher` - 規則匹配引擎
- `VoiceConfig` - 語音配置管理

### 配置檔案
- `rules/badminton_rules.yaml` - 語音指令規則定義
- 支援優先級、多種匹配方式、自訂回覆

## 🛠️ 自訂指令

您可以編輯 `rules/badminton_rules.yaml` 來新增或修改語音指令：

```yaml
- id: "custom_training"
  priority: 80
  match:
    contains: ["特殊訓練", "自訂練習"]
  reply:
    text: "開始特殊訓練模式！"
    voice: "nova"
  action: "custom_training_action"
```

## 🚨 故障排除

### 常見問題

#### 1. 程式閃退（Segmentation Fault）
**症狀**：啟動語音控制時程式崩潰
**解決方案**：
- 使用「🎤 開始錄音（簡化版）」按鈕
- 啟用「安全模式」選項
- 檢查音訊裝置權限設定
- 嘗試不同的音訊裝置

#### 2. API Key 錯誤
**症狀**：顯示 API Key 相關錯誤
**解決方案**：
- 確認已正確設定 OPENAI_API_KEY
- 在 GUI 中重新輸入 API Key
- 檢查 API Key 是否有效且有足夠額度

#### 3. 音訊裝置問題
**症狀**：無法錄音或音訊錯誤
**解決方案**：
- 檢查麥克風權限設定
- 嘗試不同的音訊裝置
- 重新啟動應用程式
- 檢查系統音訊設定

#### 4. 依賴套件錯誤
**症狀**：匯入模組失敗
**解決方案**：
```bash
pip install -r requirements.txt --force-reinstall
```

#### 5. 規則不匹配
**症狀**：語音指令無法識別
**解決方案**：
- 檢查 rules/badminton_rules.yaml 檔案
- 確認語音指令用詞正確
- 查看語音識別結果是否準確

### 使用模式建議

#### 🔧 標準模式（推薦）
- 適用於大多數情況
- 自動語音活動偵測
- 完整功能支援

#### 🛡️ 安全模式
- 解決記憶體問題
- 固定時長錄音
- 簡化錯誤處理

#### 🎤 簡化版模式
- 解決閃退問題
- 手動觸發錄音
- 最穩定的選擇

### 除錯方式
- 查看語音對話記錄視窗中的訊息
- 確認語音識別結果是否正確
- 測試規則匹配是否正常運作
- 檢查系統日誌檔案

## 📈 效能優化

- 使用 VAD 自動偵測語音活動，減少不必要的 API 呼叫
- 智能快取系統減少重複處理
- 並行處理音訊捕獲和語音識別
- 預載入常用回覆模板

## 🔄 向後相容性

- 舊版 `voice_control.py` 仍然保留並可正常使用
- 新舊系統可以共存，不會互相干擾
- 現有的語音控制功能不受影響

## 🎉 使用建議

1. 首次使用建議先測試基本指令（開始/停止訓練）
2. 說話時保持清晰，避免背景雜音
3. 可以使用自然語言，不需要完全按照範例指令
4. 系統會提供語音回覆確認指令執行狀態
5. 如遇問題，可查看對話記錄視窗的詳細訊息

---

🏸 **享受智能語音控制帶來的全新羽球訓練體驗！**
